<div class="space-y-6">
  <!-- Título -->
  <div class="flex items-center justify-between">
    <h2 class="text-xl font-semibold text-slate-100">{{ titulo() }}</h2>
    <a routerLink="/dashboard" class="text-sm text-emerald-400 hover:underline cursor-pointer">Volver al dashboard</a>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Form -->
    <div class="lg:col-span-2 rounded-2xl bg-slate-900/60 p-5 border border-white/10">
      <!-- Switch gasto/ingreso -->
      <div class="flex items-center gap-2 mb-4">
        <button type="button"
                (click)="setTipo(0)"
                class="px-3 py-1.5 rounded-lg border cursor-pointer transition focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-400/50"
                [attr.aria-pressed]="!isIngreso()"
                [ngClass]="!isIngreso()
                  ? 'bg-rose-600 text-white border-rose-600 ring-2 ring-rose-400/40 shadow-sm'
                  : 'bg-slate-800 text-slate-200 hover:bg-slate-700 border-white/10'">
          Gasto
        </button>
        <button type="button"
                (click)="setTipo(1)"
                class="px-3 py-1.5 rounded-lg border cursor-pointer transition focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400/50"
                [attr.aria-pressed]="isIngreso()"
                [ngClass]="isIngreso()
                  ? 'bg-emerald-600 text-white border-emerald-600 ring-2 ring-emerald-400/40 shadow-sm'
                  : 'bg-slate-800 text-slate-200 hover:bg-slate-700 border-white/10'">
          Ingreso
        </button>
      </div>

      <!-- form -->
      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="grid sm:grid-cols-2 gap-4" novalidate>
        <!-- Monto -->
        <div>
          <label class="block text-sm text-slate-300 mb-1">Monto *</label>
          <input type="number" inputmode="decimal" step="0.01" min="0.01" placeholder="0.00"
                 class="w-full rounded-lg border border-white/10 bg-slate-950/60 px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400 text-slate-100 placeholder-slate-500"
                 [class.border-red-400]="invalid('monto')"
                 formControlName="monto">
          @if (invalid('monto')) { <p class="mt-1 text-xs text-rose-400">Ingresa un monto válido (≥ 0.01).</p> }
        </div>

        <!-- Fecha -->
        <div>
          <label class="block text-sm text-slate-300 mb-1">Fecha *</label>
          <input type="date"
                 class="w-full rounded-lg border border-white/10 bg-slate-950/60 px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400 text-slate-100"
                 [class.border-red-400]="invalid('fechaTransaccion')"
                 formControlName="fechaTransaccion">
          @if (invalid('fechaTransaccion')) { <p class="mt-1 text-xs text-rose-400">Selecciona una fecha.</p> }
        </div>

        <!-- Cuenta -->
        <div>
          <label class="block text-sm text-slate-300 mb-1">Cuenta *</label>
          <select
            class="w-full rounded-lg border border-white/10 bg-slate-950/60 px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400 text-slate-100 cursor-pointer"
            [class.border-red-400]="invalid('idCuenta')"
            formControlName="idCuenta">
            <option [ngValue]="null" disabled>Selecciona una cuenta</option>
            @for (c of cuentas(); track c.id) {
              <option class="bg-slate-900 text-slate-100" [ngValue]="c.id">{{ c.nombre }}</option>
            }
          </select>
          @if (invalid('idCuenta')) { <p class="mt-1 text-xs text-rose-400">Selecciona una cuenta.</p> }
        </div>

        <!-- Categoría -->
        <div>
          <label class="block text-sm text-slate-300 mb-1">Categoría *</label>
          <select
            class="w-full rounded-lg border border-white/10 bg-slate-950/60 px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400 text-slate-100 cursor-pointer"
            [class.border-red-400]="invalid('idCategoria')"
            formControlName="idCategoria">
            <option [ngValue]="null" disabled>Selecciona una categoría</option>
            @for (c of categorias(); track c.id) {
              <option class="bg-slate-900 text-slate-100" [ngValue]="c.id">{{ c.nombre }}</option>
            }
          </select>
          @if (invalid('idCategoria')) { <p class="mt-1 text-xs text-rose-400">Selecciona una categoría.</p> }
        </div>

        <!-- Nota -->
        <div class="sm:col-span-2">
          <label class="block text-sm text-slate-300 mb-1">Nota (opcional)</label>
          <input type="text" placeholder="Ej. Almuerzo, peaje, gasolina…"
                 class="w-full rounded-lg border border-white/10 bg-slate-950/60 px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400 text-slate-100 placeholder-slate-500"
                 formControlName="nota">
        </div>

        <!-- Botones -->
        <div class="sm:col-span-2 flex items-center justify-end gap-2 mt-2">
          <button type="button" class="px-4 py-2 rounded-lg border border-white/10 bg-slate-800 text-slate-200 hover:bg-slate-700 cursor-pointer"
                  (click)="resetForm()" [disabled]="cargando()">
            Limpiar
          </button>
          <button type="submit"
                  class="px-4 py-2 rounded-lg text-white cursor-pointer disabled:opacity-60 disabled:cursor-not-allowed"
                  [ngClass]="isIngreso() ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-rose-600 hover:bg-rose-700'"
                  [disabled]="cargando()">
            {{ cargando() ? 'Guardando…' : 'Guardar' }}
          </button>
        </div>
      </form>
    </div>

    <!-- Recientes -->
    <div class="rounded-2xl bg-slate-900/60 p-5 border border-white/10">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-slate-100">Últimas transacciones</h3>
        <button type="button" (click)="scrollToAll()"
                class="text-sm text-emerald-400 hover:underline cursor-pointer">
          Ver todas
        </button>
      </div>

      <div class="mt-3 divide-y divide-white/5">
        @if (!recientes().length) {
          <div class="text-sm text-slate-400">Sin transacciones recientes.</div>
        } @else {
          @for (t of recientes(); track t.idTransaccion) {
            <div class="py-3 flex items-center justify-between gap-3">
              <div class="flex items-center gap-3">
                <div class="h-8 w-8 rounded-full grid place-items-center"
                     [ngClass]="{
                       'bg-emerald-200/20 text-emerald-400': t.tipoTransaccion === 1,
                       'bg-rose-200/20 text-rose-400': t.tipoTransaccion === 0
                     }">
                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path *ngIf="t.tipoTransaccion === 1" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"/>
                    <path *ngIf="t.tipoTransaccion === 0" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 12H5m7 7l-7-7 7-7"/>
                  </svg>
                </div>
                <div>
                  <div class="text-sm font-medium text-slate-100">{{ t.categoria }}</div>
                  <div class="text-xs text-slate-400">
                    {{ t.cuenta }} · {{ t.fechaTransaccion | date:'mediumDate' }}
                    @if (t.nota) { · <span class="italic">{{ t.nota }}</span> }
                  </div>
                </div>
              </div>
              <div class="text-sm font-semibold"
                   [class.text-emerald-400]="t.tipoTransaccion === 1"
                   [class.text-rose-400]="t.tipoTransaccion === 0">
                {{ (t.tipoTransaccion === 1 ? '+' : '-') }}{{ t.monto | currency:'DOP':'symbol':'1.0-0' }}
              </div>
            </div>
          }
        }
      </div>
    </div>
  </div>

  <!-- === TODAS LAS TRANSACCIONES (tabla) === -->
  <div id="all-transacciones" class="rounded-2xl bg-slate-900/60 p-5 border border-white/10">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div class="flex items-center gap-2">
        <button type="button" class="p-2 rounded-md bg-white text-slate-700 hover:bg-slate-100 cursor-pointer"
                (click)="prevMes()" aria-label="Mes anterior">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        </button>
        <div class="text-sm font-semibold text-slate-100">
          {{ fmtPeriodo(periodo()) | titlecase }}
        </div>
        <button type="button" class="p-2 rounded-md bg-white text-slate-700 hover:bg-slate-100 cursor-pointer"
                (click)="nextMes()" aria-label="Mes siguiente">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </button>
      </div>

      <div class="relative w-full sm:w-80">
        <input type="text" placeholder="Buscar por categoría, cuenta o nota…"
               class="w-full pl-8 pr-20 py-2 rounded-lg border outline-none
                      bg-slate-950/60 text-slate-100 placeholder-slate-500
                      border-white/10 focus:ring-2 focus:ring-emerald-400"
               aria-describedby="tx-busqueda-hint"
               [formControl]="buscarCtrl" (keyup.enter)="buscarAhora()">
        <svg class="h-4 w-4 absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400"
             viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-4.35-4.35M10 18a8 8 0 110-16 8 8 0 010 16z"/>
        </svg>
        <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1">
          <button type="button"
                  class="px-2 py-1 rounded-md border border-white/10 text-xs text-slate-300 hover:bg-slate-800/60 cursor-pointer"
                  (click)="buscarAhora()">Buscar</button>
          <button type="button"
                  class="px-2 py-1 rounded-md border border-white/10 text-xs text-slate-300 hover:bg-slate-800/60 cursor-pointer"
                  (click)="limpiarBuscar()">Limpiar</button>
        </div>
        <!-- Hint de búsqueda -->
        <p id="tx-busqueda-hint" class="mt-1 text-[11px] text-slate-400">
          Busca por <b>categoría</b>, <b>cuenta</b> o <b>nota</b>.
        </p>
      </div>
    </div>

    <div class="mt-4 overflow-x-auto">
      <table class="w-full min-w-[760px] text-sm">
        <thead class="text-slate-400">
          <tr class="border-b border-white/10">
            <th class="py-2 text-left w-40 pl-3">Fecha</th>
            <th class="py-2 text-left w-44">Cuenta</th>
            <th class="py-2 text-left w-48">Categoría</th>
            <th class="py-2 text-left w-28">Tipo</th>
            <th class="py-2 text-right w-40 pr-3">Monto</th>
            <th class="py-2 text-left min-w-[200px] pl-3">Nota</th>
          </tr>
        </thead>
        <tbody>
          @if (!lista().length) {
            <tr><td class="py-4 text-slate-400 pl-3" colspan="6">No hay transacciones en este período.</td></tr>
          } @else {
            @for (t of lista(); track t.idTransaccion) {
              <tr class="border-b border-white/5 hover:bg-slate-800/40">
                <td class="py-2 pl-3">{{ t.fechaTransaccion | date:'mediumDate' }}</td>
                <td class="py-2">{{ t.cuenta }}</td>
                <td class="py-2">{{ t.categoria }}</td>
                <td class="py-2">
                  <span class="px-2 py-0.5 rounded-full border text-xs"
                        [ngClass]="{
                          'border-rose-500/40 text-rose-300': t.tipoTransaccion===0,
                          'border-emerald-500/40 text-emerald-300': t.tipoTransaccion===1
                        }">
                    {{ t.tipoTransaccion===0 ? 'Gasto' : 'Ingreso' }}
                  </span>
                </td>
                <td class="py-2 text-right font-semibold pr-3"
                    [class.text-rose-300]="t.tipoTransaccion===0"
                    [class.text-emerald-300]="t.tipoTransaccion===1">
                  {{ (t.tipoTransaccion===1 ? '+' : '-') }}{{ t.monto | currency:'DOP':'symbol':'1.0-0' }}
                </td>
                <td class="py-2 text-slate-300 truncate max-w-[360px] pl-3">{{ t.nota }}</td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="mt-3 flex items-center justify-between text-sm text-slate-300">
      <div>
        Página {{ pagina() }} ·
        Mostrando {{ lista().length }} de {{ total() }} registros
      </div>
      <div class="flex items-center gap-2">
        <button type="button"
                class="px-3 py-1.5 rounded-md border border-white/10 bg-slate-800 text-slate-200 hover:bg-slate-700 disabled:opacity-50 cursor-pointer"
                (click)="irPag(-1)" [disabled]="pagina()<=1">
          Anterior
        </button>
        <button type="button"
                class="px-3 py-1.5 rounded-md border border-white/10 bg-slate-800 text-slate-200 hover:bg-slate-700 disabled:opacity-50 cursor-pointer"
                (click)="irPag(1)" [disabled]="pagina()*tamPagina >= total()">
          Siguiente
        </button>
      </div>
    </div>
  </div>
</div>
