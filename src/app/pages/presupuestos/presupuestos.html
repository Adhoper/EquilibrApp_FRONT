<div class="space-y-6">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div class="flex items-center gap-3">
      <h2 class="text-xl font-semibold text-slate-100">Presupuestos</h2>
      <span class="text-xs text-slate-400">Define límites mensuales y monitorea su uso</span>
    </div>

    <!-- Selector de mes -->
    <div class="flex items-center gap-2">
      <button type="button" class="p-2 rounded-md bg-white text-slate-700 hover:bg-slate-100 cursor-pointer"
              (click)="prevMes()" aria-label="Mes anterior">
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      <div class="text-sm font-semibold text-slate-100">{{ fmtPeriodo(periodo()) | titlecase }}</div>
      <button type="button" class="p-2 rounded-md bg-white text-slate-700 hover:bg-slate-100 cursor-pointer"
              (click)="nextMes()" aria-label="Mes siguiente">
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Formulario de presupuesto por categoría -->
    <div class="lg:col-span-2 rounded-2xl p-5 border bg-slate-900/60 border-white/10">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <h3 class="font-semibold text-slate-100">
            {{ editando() ? 'Editar presupuesto' : 'Nuevo presupuesto' }}
          </h3>
          <span
            class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px] uppercase tracking-wide"
            [ngClass]="
              editando()
                ? 'border border-amber-300/30 bg-amber-400/10 text-amber-200'
                : 'border border-emerald-300/30 bg-emerald-400/10 text-emerald-200'
            "
          >
            {{ editando() ? 'Editando' : 'Nuevo' }}
          </span>
        </div>

        @if (editando()) {
          <button type="button"
                  class="text-xs text-emerald-300 hover:text-emerald-200 underline cursor-pointer"
                  (click)="limpiarForm()">
            Crear nuevo
          </button>
        }
      </div>

      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="grid sm:grid-cols-3 gap-4" novalidate>
        <!-- Periodo (solo lectura – toma el periodo actual del módulo) -->
        <div>
          <label class="block text-sm text-slate-300 mb-1">Periodo</label>
          <input type="text" [value]="periodo()" disabled
                 class="w-full rounded-lg border px-3 py-2 bg-slate-900/40 text-slate-300 border-white/10">
          <p class="mt-1 text-[11px] text-slate-400">Usa los botones de arriba para cambiar el mes.</p>
        </div>

        <!-- Categoría -->
        <div>
          <label class="block text-sm text-slate-300 mb-1">Categoría *</label>
          <select formControlName="idCategoria"
                  class="w-full rounded-lg border px-3 py-2 outline-none bg-slate-900/40 text-slate-100 border-white/10 focus:ring-2 focus:ring-emerald-400 cursor-pointer"
                  [class.border-rose-400]="invalid('idCategoria')">
            <option [ngValue]="null" disabled>Selecciona una categoría</option>
            @for (c of categorias(); track c.id) {
              <option class="bg-slate-900 text-slate-100" [ngValue]="c.id">{{ c.nombre }}</option>
            }
          </select>
          @if (invalid('idCategoria')) {
            <p class="mt-1 text-xs text-rose-400">Selecciona una categoría.</p>
          }
        </div>

        <!-- Monto límite -->
        <div>
          <label class="block text-sm text-slate-300 mb-1">Monto límite *</label>
          <input type="number" min="1" step="0.01" formControlName="montoLimite" placeholder="0.00"
                 class="w-full rounded-lg border px-3 py-2 outline-none bg-slate-900/40 text-slate-100 border-white/10 focus:ring-2 focus:ring-emerald-400"
                 [class.border-rose-400]="invalid('montoLimite')">
          @if (invalid('montoLimite')) {
            <p class="mt-1 text-xs text-rose-400">Ingresa un monto válido (≥ 1).</p>
          }
        </div>

        <div class="sm:col-span-3 flex flex-col sm:flex-row sm:items-center justify-end gap-2 pt-2">
          <button type="button"
                  class="px-4 py-2 rounded-lg border cursor-pointer bg-slate-900/40 text-slate-200 border-white/10 hover:bg-slate-800/60"
                  (click)="limpiarForm()" [disabled]="cargando()">
            Limpiar
          </button>
          <button type="submit"
                  class="px-4 py-2 rounded-lg text-white cursor-pointer disabled:opacity-60 disabled:cursor-not-allowed
                         bg-emerald-600 hover:bg-emerald-700"
                  [disabled]="cargando()">
            {{ cargando() ? 'Guardando…' : (editando() ? 'Actualizar' : 'Guardar') }}
          </button>
        </div>
      </form>
    </div>

    <!-- Presupuesto Global -->
    <div class="rounded-2xl p-5 border bg-slate-900/60 border-white/10">
      <h3 class="font-semibold text-slate-100">Presupuesto global</h3>
      <p class="text-sm text-slate-400">Límite total para el mes seleccionado.</p>

      <div class="mt-3">
        <div class="w-full h-2 rounded bg-slate-800 overflow-hidden">
          <div class="h-2"
               [ngClass]="barClass(globalUso().porcentaje)"
               [style.width.%]="clamp(globalUso().porcentaje)">
          </div>
        </div>
        <div class="mt-2 text-sm text-slate-300">
          <span class="font-medium">{{ globalUso().gastado | currency:'DOP':'symbol':'1.0-0' }}</span>
          de
          <span class="font-medium">{{ globalUso().limite | currency:'DOP':'symbol':'1.0-0' }}</span>
          · <span [class.text-emerald-300]="globalUso().restante >= 0"
                  [class.text-rose-300]="globalUso().restante < 0">
            {{ globalUso().restante >= 0 ? 'Disponible' : 'Excedido' }}:
            {{ (globalUso().restante >=0 ? globalUso().restante : (globalUso().restante * -1)) | currency:'DOP':'symbol':'1.0-0' }}
          </span>
        </div>
      </div>

      <form [formGroup]="formGlobal" (ngSubmit)="guardarGlobal()" class="mt-4 flex items-end gap-2" novalidate>
        <div class="flex-1">
          <label class="block text-sm text-slate-300 mb-1">Límite global *</label>
          <input type="number" min="1" step="0.01" formControlName="montoLimiteGlobal" placeholder="0.00"
                 class="w-full rounded-lg border px-3 py-2 outline-none bg-slate-900/40 text-slate-100 border-white/10 focus:ring-2 focus:ring-emerald-400"
                 [class.border-rose-400]="invalidGlobal('montoLimiteGlobal')">
          @if (invalidGlobal('montoLimiteGlobal')) {
            <p class="mt-1 text-xs text-rose-400">Ingresa un monto válido (≥ 1).</p>
          }
        </div>
        <button type="submit"
                class="px-4 py-2 rounded-lg text-white cursor-pointer disabled:opacity-60 disabled:cursor-not-allowed
                       bg-emerald-600 hover:bg-emerald-700"
                [disabled]="cargando()">
          {{ cargando() ? 'Guardando…' : 'Guardar' }}
        </button>
      </form>
    </div>
  </div>

  <!-- Listado + uso por categoría -->
  <div class="rounded-2xl p-5 border bg-slate-900/60 border-white/10">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <h3 class="font-semibold text-slate-100">Presupuestos por categoría</h3>

      <div class="flex flex-wrap items-center gap-2">
        <button type="button"
                class="px-3 py-1.5 rounded-full text-xs border cursor-pointer bg-slate-900/40 text-slate-300 border-white/10 hover:bg-slate-800/60"
                [ngClass]="{ 'bg-emerald-600 text-white border-emerald-600': soloActivos() }"
                (click)="setSoloActivos(true)">
          Activos
        </button>
        <button type="button"
                class="px-3 py-1.5 rounded-full text-xs border cursor-pointer bg-slate-900/40 text-slate-300 border-white/10 hover:bg-slate-800/60"
                [ngClass]="{ 'bg-slate-700 text-white border-slate-700': !soloActivos() }"
                (click)="setSoloActivos(false)">
          Inactivos
        </button>
      </div>
    </div>

    <div class="mt-4 overflow-x-auto">
      <table class="w-full min-w-[760px] text-sm">
        <thead class="text-slate-400">
          <tr class="border-b border-white/10">
            <th class="py-2 text-left w-56">Categoría</th>
            <th class="py-2 text-left w-40">Límite</th>
            <th class="py-2 text-left w-40">Gastado</th>
            <th class="py-2 text-left w-28">Uso</th>
            <th class="py-2 text-left">Progreso</th>
            <th class="py-2 text-right w-40">Acciones</th>
          </tr>
        </thead>
        <tbody>
          @if (!presupuestosFiltrados().length) {
            <tr>
              <td class="py-4 text-slate-400" colspan="6">No hay presupuestos para este período.</td>
            </tr>
          } @else {
            @for (p of presupuestosFiltrados(); track p.idPresupuesto) {
              <tr class="border-b border-white/5 hover:bg-slate-800/40">
                <td class="py-2">
                  <div class="flex items-center gap-2">
                    <span class="h-3 w-3 rounded-sm border border-white/10"
                          [ngStyle]="{ 'background-color': p.colorHexadecimal || '#22C55E' }"></span>
                    <span class="text-slate-100">{{ p.categoria }}</span>
                  </div>
                </td>
                <td class="py-2 text-slate-300">{{ p.montoLimite | currency:'DOP':'symbol':'1.0-0' }}</td>
                <td class="py-2 text-slate-300">{{ usoDe(p.idCategoria).gastado | currency:'DOP':'symbol':'1.0-0' }}</td>
                <td class="py-2">
                  <span class="px-2 py-0.5 rounded-full border text-xs"
                        [ngClass]="pillClass(usoDe(p.idCategoria).porcentaje)">
                    {{ clamp(usoDe(p.idCategoria).porcentaje) | number:'1.0-0' }}%
                  </span>
                </td>
                <td class="py-2">
                  <div class="w-full h-2 rounded bg-slate-800 overflow-hidden">
                    <div class="h-2" [ngClass]="barClass(usoDe(p.idCategoria).porcentaje)"
                         [style.width.%]="clamp(usoDe(p.idCategoria).porcentaje)">
                    </div>
                  </div>
                </td>
                <td class="py-2 text-right">
                  <div class="inline-flex items-center gap-1 shrink-0">
                    <button type="button"
                            class="px-2 py-1 rounded-md border border-white/10 text-slate-200 hover:bg-slate-800/60 cursor-pointer"
                            (click)="editar(p)">
                      Editar
                    </button>
                    <button type="button"
                            class="px-2 py-1 rounded-md border text-slate-200 cursor-pointer hover:bg-slate-800/60"
                            [ngClass]="{
                              'border-slate-600': (p.estatus ?? 'A')==='A',
                              'border-emerald-600': (p.estatus ?? 'A')==='I'
                            }"
                            (click)="toggleEstatus(p)">
                      {{ (p.estatus ?? 'A')==='A' ? 'Desactivar' : 'Activar' }}
                    </button>
                  </div>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
  </div>
</div>
